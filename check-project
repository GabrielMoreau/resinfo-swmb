#!/bin/bash
#
# 2020/06/11 Gabriel Moreau


NB_SWMB=$(grep -hEi '^Function[[:space:]](Enable|Disable)' $(find . -path ./Win10-Initial-Setup-Script -prune -o -name '*.psm1' -print) | awk '{print $2}' | wc -l)
NB_TOTAL=$(grep -hEi '^Function[[:space:]](Enable|Disable)' $(find . -name '*.psm1' -print) | awk '{print $2}' | wc -l)

echo "Info: number of SWMB  rules: ${NB_SWMB} / $((${NB_SWMB}/2)) (enable and disable)"
echo "Info: number of total rules: ${NB_TOTAL} / $((${NB_TOTAL}/2)) (enable and disable)"

NB_DOUBLEDEF=$(grep -hEi '^Function[[:space:]](Enable|Disable)' $(find . -name '*.psm1' -print) \
   | awk '{print $2}' \
   | sed -Ee 's/^(Enable|Disable)//i;' \
   | sort \
   | uniq -c \
   | grep -v '^      2 ' \
   | tr '\n' '&')
if [ $(echo ${NB_DOUBLEDEF} | tr '&' '\n' | head -n -1 | wc -l) -gt 0 ]
then
   echo ${NB_DOUBLEDEF} | tr '&' '\n' | head -n -1 | awk '{print "Error: multiple (" $1/2 ") definition of function: " $2}'
fi

for rule in $(grep -hEi '^Function[[:space:]](Enable|Disable)' $(find . -path ./Win10-Initial-Setup-Script -prune -o -name '*.psm1' -print) \
   | awk '{print $2}' \
   | sed -Ee 's/^(Enable|Disable)//i;' \
   | sort -u)
do
   if ! grep -Eq "^(#[[:space:]])?(Enable|Disable)${rule}" Presets/*.preset
   then
      echo "Warning: no preset proposed for rule: ${rule}"
   fi
done
